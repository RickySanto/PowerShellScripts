######################################################################################################################################
### Name:        Decommission-VMs.ps1                                                                                               ###
### Author:      Riccardo Santoni                                                                                                   ###                                                                                                           
### Description: This script takes a list of servers from a text file and verify whether the server has 2 registry key set as per   ###
###              vulnerability remediation requirements. If not the keys will be set to the right value to fix the vulneability.    ###
###              The vulnerabiltiy in question is Microsoft IE CVE-2017-8529                                                        ###                                                                                          
######################################################################################################################################

#Scipt will ask for credentials to run
$Cred = Get-Credential
#Get list of VMs from a text file
$Servers = Get-Content "C:\PATH\IEremediation.txt"


foreach($Server in $Servers) {
    
    $session = New-PSSession $Server -Credential $Cred 
    
    #Action result stores the value of the operation that's run on the remote server using the Invoke-Command
    $ActionResult = Invoke-Command -session $session -ArgumentList $Server -ScriptBlock  {
   
        $Server = $args[0]

        #Checking first key value
        $oldvalue1 = Get-ItemProperty -Path "hklm:\SOFTWARE\Microsoft\Internet Explorer\Main\FeatureControl\FEATURE_ENABLE_PRINT_INFO_DISCLOSURE_FIX" -Name iexplorer.exe
        Write-Host $oldvalue1
        #if key do not exists the key will be added 
        if ($oldvalue1 -eq $null) {
             reg add "HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Internet Explorer\Main\FeatureControl\FEATURE_ENABLE_PRINT_INFO_DISCLOSURE_FIX" /v "iexplorer.exe" /t REG_DWORD /d 1
             $newvalue = Get-ItemProperty -Path "hklm:\SOFTWARE\Microsoft\Internet Explorer\Main\FeatureControl\FEATURE_ENABLE_PRINT_INFO_DISCLOSURE_FIX" -Name iexplorer.exe
             $Output1 = "The key FEATURE_ENABLE_PRINT_INFO_DISCLOSURE_FIX has been added to " + $Server + " with value " + $newvalue.'iexplorer.exe'
        #if key already set to the right value no action required output will be produced    
        } else {
            if ($oldvalue1.'iexplorer.exe' -eq 1) {
            $Output1 = "no action needed key FEATURE_ENABLE_PRINT_INFO_DISCLOSURE_FIX - Server " + $Server
        #if key set to the incorrect value the value will be changed to the right one producint the output of the change made    
            } else {
            Set-ItemProperty -Path "hklm:\SOFTWARE\Microsoft\Internet Explorer\Main\FeatureControl\FEATURE_ENABLE_PRINT_INFO_DISCLOSURE_FIX" -Name iexplorer.exe -Value 1
            $newvalue = Get-ItemProperty -Path "hklm:\SOFTWARE\Microsoft\Internet Explorer\Main\FeatureControl\FEATURE_ENABLE_PRINT_INFO_DISCLOSURE_FIX" -Name iexplorer.exe
            $Output1 = $Server + " key value " + $oldvalue + " has been changed to " + $newvalue
            }
        }
        
        Write-Host $Output1
        
        #Checking second key value
        $oldvalue2 = Get-ItemProperty -Path "hklm:\SOFTWARE\WOW6432Node\Microsoft\Internet Explorer\Main\FeatureControl\FEATURE_ENABLE_PRINT_INFO_DISCLOSURE_FIX" -Name iexplorer.exe
        write-host $oldvalue2
        #if key do not exists the key will be added 
        if ($oldvalue2 -eq $null) {
             reg add "HKEY_LOCAL_MACHINE\SOFTWARE\WOW6432Node\Microsoft\Internet Explorer\Main\FeatureControl\FEATURE_ENABLE_PRINT_INFO_DISCLOSURE_FIX" /v "iexplorer.exe" /t REG_DWORD /d 1
             $newvalue = Get-ItemProperty -Path "hklm:\SOFTWARE\Microsoft\Internet Explorer\Main\FeatureControl\FEATURE_ENABLE_PRINT_INFO_DISCLOSURE_FIX" -Name iexplorer.exe
             $Output2 = "The key FEATURE_ENABLE_PRINT_INFO_DISCLOSURE_FIX 64 bit has been added to  " + $Server + " with value " + $newvalue.'iexplorer.exe'
        #if key already set to the right value no action required output will be produced 
        } else {
            if ($oldvalue2.'iexplorer.exe' -eq 1) {
            $Output2 = "no action needed key FEATURE_ENABLE_PRINT_INFO_DISCLOSURE_FIX 64 bit - Server " + $Server
        #if key set to the incorrect value the value will be changed to the right one producint the output of the change made 
            } else {
            Set-ItemProperty -Path "hklm:\SOFTWARE\Microsoft\Internet Explorer\Main\FeatureControl\FEATURE_ENABLE_PRINT_INFO_DISCLOSURE_FIX" -Name iexplorer.exe -Value 1
            $newvalue = Get-ItemProperty -Path "hklm:\SOFTWARE\Microsoft\Internet Explorer\Main\FeatureControl\FEATURE_ENABLE_PRINT_INFO_DISCLOSURE_FIX" -Name iexplorer.exe
            $Output2 = $Server + "key value" + $oldvalue2.'iexplorer.exe' +" has been changed to " + $newvalue.'iexplorer.exe'
            }    
        }
         Write-Host $Output2
         #Return back form the remote session the result of the 2 operation combined
         Return $Output1 + "`n" + $Output2
    }
    
    Add-Content "C:\PATH\ieregistry_result.txt" $ActionResult
    Get-PSSession | Remove-PSSession

}